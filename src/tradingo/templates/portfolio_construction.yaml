# Template setsup portfolio constructor, backtester and
# PIT position tasks.
#
# 1. name: the name of the portfolio
# 2. model_weights: the model weights dictionary
# 3. portfolio: Some params releavant to pf constuction function
#   1. currency: Optional - the currency of the portfolio
#   2. multiplier: the multiplier to apply
#   3. aum: the aum value
# 4. position: the position type to use, e.g rounded.shares
# 5. bid_close: the bid close symbol to use
# 6. ask_close: the ask close symbol to use
# 7. data_interval_start: the start of interval for PIT construction
# 7. data_interval_end: the end of interval for PIT construction
"portfolio.{{ name }}":
  depends_on:
    #{% for model in model_weights %}
    - "signals.{{ model }}"
  #{% endfor %}
  function: tradingo.portfolio.portfolio_construction
  symbols_in:
    instruments:
      #{% for model in model_weights %}
      - "instruments/{{ universe_name }}"
    #{% endfor %}
    close:
      #{% for model in model_weights %}
      #{% if portfolio.currency is defined %}
      - "prices/{{ model }}.mid.close.{{ portfolio.currency }}"
      #{% else %}
      - "prices/{{ universe_name }}.mid.close"
    #{% endif %}
    #{% endfor %}
  symbols_out:
    - "portfolio/{{ name }}.raw.percent"
    - "portfolio/{{ name }}.raw.shares"
    - "portfolio/{{ name }}.raw.position"
    - "portfolio/{{ name }}.rounded.percent"
    - "portfolio/{{ name }}.rounded.shares"
    - "portfolio/{{ name }}.rounded.position"
    - "signals/{{ name }}.raw.signal"
  params:
    model_weights: {{ model_weights }}
    multiplier: {{ portfolio.multiplier }}
    aum: {{ portfolio.aum }}
"backtest.{{ name }}":
  depends_on:
    - "portfolio.{{ name }}"
  function: "tradingo.backtest.backtest"
  params:
    price_ffill_limit: {{ backtest.price_ffill_limit }}
  symbols_in:
    portfolio: "{{ position }}"
    bid_close: "{{ bid_close }}"
    ask_close: "{{ ask_close }}"
  symbols_out:
    - backtest/{{ name }}.portfolio
    - backtest/{{ name }}.instrument.unrealised_pnl
    - backtest/{{ name }}.instrument.realised_pnl
    - backtest/{{ name }}.instrument.total_pnl
    - backtest/{{ name }}.instrument.net_investment
    - backtest/{{ name }}.instrument.net_position
    - backtest/{{ name }}.instrument.net_exposure
    - backtest/{{ name }}.instrument.avg_open_price
    - backtest/{{ name }}.instrument.stop_trade

"portfolio.point_in_time.{{ name }}":
  depends_on:
    - "portfolio.{{ name }}"
  function: tradingo.portfolio.point_in_time_position
  symbols_in:
    positions: "portfolio/{{ name }}.rounded.position"
  symbols_out:
    - "portfolio/{{ name }}.rounded.pit_position"
  params:
    start_date: "{{ data_interval_start }}"
    end_date: "{{ data_interval_end }}"
